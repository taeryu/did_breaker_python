#!/usr/bin/env python3
"""
ğŸ§ª DSD Breaker ê°ì‚¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
DART ê°ì‚¬ë³´ê³ ì„œ ê²€ì¦ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ìŠ¤í¬ë¦½íŠ¸
"""

import pandas as pd
import numpy as np
import os
from pathlib import Path

def create_sample_financial_data():
    """ê°ì‚¬ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ì˜ ìƒ˜í”Œ ì¬ë¬´ì œí‘œ ìƒì„±"""
    
    # ì¬ë¬´ìƒíƒœí‘œ ìƒ˜í”Œ ë°ì´í„°
    balance_sheet_data = {
        'í•­ëª©': [
            'ìì‚°',
            '  ìœ ë™ìì‚°',
            '    í˜„ê¸ˆë°í˜„ê¸ˆì„±ìì‚°',
            '    ë‹¨ê¸°ê¸ˆìœµìƒí’ˆ', 
            '    ë§¤ì¶œì±„ê¶Œ',
            '    ì¬ê³ ìì‚°',
            '  ìœ ë™ìì‚° í•©ê³„',
            '  ë¹„ìœ ë™ìì‚°',
            '    íˆ¬ììì‚°',
            '    ìœ í˜•ìì‚°',
            '    ë¬´í˜•ìì‚°',
            '  ë¹„ìœ ë™ìì‚° í•©ê³„',
            'ìì‚°ì´ê³„',
            'ë¶€ì±„',
            '  ìœ ë™ë¶€ì±„',
            '    ë§¤ì…ì±„ë¬´',
            '    ë‹¨ê¸°ì°¨ì…ê¸ˆ',
            '  ìœ ë™ë¶€ì±„ í•©ê³„',
            '  ë¹„ìœ ë™ë¶€ì±„',
            '    ì¥ê¸°ì°¨ì…ê¸ˆ',
            '  ë¹„ìœ ë™ë¶€ì±„ í•©ê³„',
            'ë¶€ì±„ì´ê³„',
            'ìë³¸',
            '  ìë³¸ê¸ˆ',
            '  ì´ìµì‰ì—¬ê¸ˆ',
            'ìë³¸ì´ê³„',
            'ë¶€ì±„ë°ìë³¸ì´ê³„'
        ],
        '2023': [
            '',  # ìì‚° (í—¤ë”)
            '',  # ìœ ë™ìì‚° (í—¤ë”)
            50000,  # í˜„ê¸ˆë°í˜„ê¸ˆì„±ìì‚°
            30000,  # ë‹¨ê¸°ê¸ˆìœµìƒí’ˆ
            40000,  # ë§¤ì¶œì±„ê¶Œ
            25000,  # ì¬ê³ ìì‚°
            145000,  # ìœ ë™ìì‚° í•©ê³„
            '',  # ë¹„ìœ ë™ìì‚° (í—¤ë”)
            20000,  # íˆ¬ììì‚°
            80000,  # ìœ í˜•ìì‚°
            15000,  # ë¬´í˜•ìì‚°
            115000,  # ë¹„ìœ ë™ìì‚° í•©ê³„
            260000,  # ìì‚°ì´ê³„
            '',  # ë¶€ì±„ (í—¤ë”)
            '',  # ìœ ë™ë¶€ì±„ (í—¤ë”)
            25000,  # ë§¤ì…ì±„ë¬´
            20000,  # ë‹¨ê¸°ì°¨ì…ê¸ˆ
            45000,  # ìœ ë™ë¶€ì±„ í•©ê³„
            '',  # ë¹„ìœ ë™ë¶€ì±„ (í—¤ë”)
            40000,  # ì¥ê¸°ì°¨ì…ê¸ˆ
            40000,  # ë¹„ìœ ë™ë¶€ì±„ í•©ê³„
            85000,  # ë¶€ì±„ì´ê³„
            '',  # ìë³¸ (í—¤ë”)
            100000,  # ìë³¸ê¸ˆ
            75000,  # ì´ìµì‰ì—¬ê¸ˆ
            175000,  # ìë³¸ì´ê³„
            260000   # ë¶€ì±„ë°ìë³¸ì´ê³„
        ],
        '2022': [
            '',  # ìì‚° (í—¤ë”)
            '',  # ìœ ë™ìì‚° (í—¤ë”)
            45000,  # í˜„ê¸ˆë°í˜„ê¸ˆì„±ìì‚°
            25000,  # ë‹¨ê¸°ê¸ˆìœµìƒí’ˆ
            35000,  # ë§¤ì¶œì±„ê¶Œ
            20000,  # ì¬ê³ ìì‚°
            125000,  # ìœ ë™ìì‚° í•©ê³„
            '',  # ë¹„ìœ ë™ìì‚° (í—¤ë”)
            18000,  # íˆ¬ììì‚°
            75000,  # ìœ í˜•ìì‚°
            12000,  # ë¬´í˜•ìì‚°
            105000,  # ë¹„ìœ ë™ìì‚° í•©ê³„
            230000,  # ìì‚°ì´ê³„
            '',  # ë¶€ì±„ (í—¤ë”)
            '',  # ìœ ë™ë¶€ì±„ (í—¤ë”)
            22000,  # ë§¤ì…ì±„ë¬´
            18000,  # ë‹¨ê¸°ì°¨ì…ê¸ˆ
            40000,  # ìœ ë™ë¶€ì±„ í•©ê³„
            '',  # ë¹„ìœ ë™ë¶€ì±„ (í—¤ë”)
            35000,  # ì¥ê¸°ì°¨ì…ê¸ˆ
            35000,  # ë¹„ìœ ë™ë¶€ì±„ í•©ê³„
            75000,  # ë¶€ì±„ì´ê³„
            '',  # ìë³¸ (í—¤ë”)
            100000,  # ìë³¸ê¸ˆ
            55000,  # ì´ìµì‰ì—¬ê¸ˆ
            155000,  # ìë³¸ì´ê³„
            230000   # ë¶€ì±„ë°ìë³¸ì´ê³„
        ]
    }
    
    # ì†ìµê³„ì‚°ì„œ ìƒ˜í”Œ ë°ì´í„°
    income_statement_data = {
        'í•­ëª©': [
            'ìˆ˜ìµ',
            '  ë§¤ì¶œ',
            '  ê¸°íƒ€ìˆ˜ìµ',
            'ìˆ˜ìµ í•©ê³„',
            'ë¹„ìš©',
            '  ë§¤ì¶œì›ê°€',
            '  íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„',
            '  ê¸°íƒ€ë¹„ìš©',
            'ë¹„ìš© í•©ê³„',
            'ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ',
            'ë²•ì¸ì„¸ë¹„ìš©',
            'ë‹¹ê¸°ìˆœì´ìµ'
        ],
        '2023': [
            '',  # ìˆ˜ìµ (í—¤ë”)
            400000,  # ë§¤ì¶œ
            5000,   # ê¸°íƒ€ìˆ˜ìµ
            405000,  # ìˆ˜ìµ í•©ê³„
            '',  # ë¹„ìš© (í—¤ë”)
            250000,  # ë§¤ì¶œì›ê°€
            80000,   # íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„
            10000,   # ê¸°íƒ€ë¹„ìš©
            340000,  # ë¹„ìš© í•©ê³„
            65000,   # ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ
            15000,   # ë²•ì¸ì„¸ë¹„ìš©
            50000    # ë‹¹ê¸°ìˆœì´ìµ
        ],
        '2022': [
            '',  # ìˆ˜ìµ (í—¤ë”)
            350000,  # ë§¤ì¶œ
            3000,   # ê¸°íƒ€ìˆ˜ìµ
            353000,  # ìˆ˜ìµ í•©ê³„
            '',  # ë¹„ìš© (í—¤ë”)
            220000,  # ë§¤ì¶œì›ê°€
            70000,   # íŒë§¤ë¹„ì™€ê´€ë¦¬ë¹„
            8000,    # ê¸°íƒ€ë¹„ìš©
            298000,  # ë¹„ìš© í•©ê³„
            55000,   # ë²•ì¸ì„¸ë¹„ìš©ì°¨ê°ì „ìˆœì´ìµ
            12000,   # ë²•ì¸ì„¸ë¹„ìš©
            43000    # ë‹¹ê¸°ìˆœì´ìµ
        ]
    }
    
    # ì˜ë„ì ì¸ ì˜¤ë¥˜ê°€ í¬í•¨ëœ ë°ì´í„°ì…‹ ìƒì„±
    error_data = balance_sheet_data.copy()
    # í•©ê³„ ì˜¤ë¥˜ ì¶”ê°€ (ìœ ë™ìì‚° í•©ê³„ë¥¼ ì˜ë„ì ìœ¼ë¡œ í‹€ë¦¬ê²Œ)
    error_data['2023'][6] = 144000  # ì‹¤ì œ: 145000
    
    # DataFrame ìƒì„±
    balance_sheet = pd.DataFrame(balance_sheet_data)
    income_statement = pd.DataFrame(income_statement_data)
    error_balance_sheet = pd.DataFrame(error_data)
    
    return balance_sheet, income_statement, error_balance_sheet

def create_sample_html():
    """ê°ì‚¬ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ì˜ HTML ìƒì„±"""
    
    html_content = '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>ê°ì‚¬ë³´ê³ ì„œ - í…ŒìŠ¤íŠ¸ìš©</title>
        <meta charset="utf-8">
    </head>
    <body>
        <h1>ì¬ë¬´ìƒíƒœí‘œ</h1>
        <table border="1">
            <tr>
                <th>í•­ëª©</th>
                <th>2023</th>
                <th>2022</th>
            </tr>
            <tr>
                <td><strong>ìì‚°</strong></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;ìœ ë™ìì‚°</td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;í˜„ê¸ˆë°í˜„ê¸ˆì„±ìì‚°</td>
                <td>50,000</td>
                <td>45,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;ë‹¨ê¸°ê¸ˆìœµìƒí’ˆ</td>
                <td>30,000</td>
                <td>25,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;ë§¤ì¶œì±„ê¶Œ</td>
                <td>40,000</td>
                <td>35,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;ì¬ê³ ìì‚°</td>
                <td>25,000</td>
                <td>20,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;ìœ ë™ìì‚° í•©ê³„</td>
                <td><strong>145,000</strong></td>
                <td><strong>125,000</strong></td>
            </tr>
            <tr>
                <td><strong>ìì‚°ì´ê³„</strong></td>
                <td><strong>260,000</strong></td>
                <td><strong>230,000</strong></td>
            </tr>
        </table>
        
        <h1>ì†ìµê³„ì‚°ì„œ</h1>
        <table border="1">
            <tr>
                <th>í•­ëª©</th>
                <th>2023</th>
                <th>2022</th>
            </tr>
            <tr>
                <td><strong>ìˆ˜ìµ</strong></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;ë§¤ì¶œ</td>
                <td>400,000</td>
                <td>350,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;ê¸°íƒ€ìˆ˜ìµ</td>
                <td>5,000</td>
                <td>3,000</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;ìˆ˜ìµ í•©ê³„</td>
                <td><strong>405,000</strong></td>
                <td><strong>353,000</strong></td>
            </tr>
            <tr>
                <td><strong>ë‹¹ê¸°ìˆœì´ìµ</strong></td>
                <td><strong>50,000</strong></td>
                <td><strong>43,000</strong></td>
            </tr>
        </table>
    </body>
    </html>
    '''
    
    return html_content

def test_audit_dependencies():
    """ê°ì‚¬ ê¸°ëŠ¥ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸"""
    
    print("ğŸ§ª DSD Breaker ê°ì‚¬ ê¸°ëŠ¥ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸")
    print("="*50)
    
    dependencies = {
        'pandas': 'pandas',
        'numpy': 'numpy',
        'beautifulsoup4': 'bs4',
        'openpyxl': 'openpyxl'
    }
    
    missing = []
    
    for package, import_name in dependencies.items():
        try:
            __import__(import_name)
            print(f"  âœ… {package}")
        except ImportError:
            print(f"  âŒ {package} - ì„¤ì¹˜ í•„ìš”")
            missing.append(package)
    
    if missing:
        print(f"\nì„¤ì¹˜ ëª…ë ¹ì–´:")
        print(f"pip install {' '.join(missing)}")
        return False
    
    return True

def main():
    """ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜"""
    
    print("ğŸ” DSD Breaker ê°ì‚¬ë³´ê³ ì„œ ê²€ì¦ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸")
    print("="*60)
    
    # 1. ì˜ì¡´ì„± ì²´í¬
    if not test_audit_dependencies():
        print("âŒ í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return
    
    print("\nâœ… ëª¨ë“  ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ")
    
    # 2. ìƒ˜í”Œ ì¬ë¬´ì œí‘œ ìƒì„±
    print("\nğŸ“Š ìƒ˜í”Œ ì¬ë¬´ì œí‘œ ìƒì„± ì¤‘...")
    
    balance_sheet, income_statement, error_balance_sheet = create_sample_financial_data()
    
    # Excel íŒŒì¼ë¡œ ì €ì¥
    with pd.ExcelWriter('sample_financial_statements.xlsx') as writer:
        balance_sheet.to_excel(writer, sheet_name='ì¬ë¬´ìƒíƒœí‘œ', index=False)
        income_statement.to_excel(writer, sheet_name='ì†ìµê³„ì‚°ì„œ', index=False)
        error_balance_sheet.to_excel(writer, sheet_name='ì˜¤ë¥˜í¬í•¨ì¬ë¬´ìƒíƒœí‘œ', index=False)
    
    print("âœ… sample_financial_statements.xlsx ìƒì„± ì™„ë£Œ")
    print(f"  ğŸ“‹ ì¬ë¬´ìƒíƒœí‘œ: {len(balance_sheet)}ê°œ í•­ëª©")
    print(f"  ğŸ“‹ ì†ìµê³„ì‚°ì„œ: {len(income_statement)}ê°œ í•­ëª©")
    print(f"  ğŸ“‹ ì˜¤ë¥˜í¬í•¨ì‹œíŠ¸: í•©ê³„ ë¶ˆì¼ì¹˜ ì˜¤ë¥˜ í¬í•¨")
    
    # 3. ìƒ˜í”Œ HTML ìƒì„±
    print("\nğŸ“„ ìƒ˜í”Œ HTML ë³´ê³ ì„œ ìƒì„± ì¤‘...")
    
    html_content = create_sample_html()
    
    with open('sample_audit_report.html', 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print("âœ… sample_audit_report.html ìƒì„± ì™„ë£Œ")
    print("  ğŸ” ì¬ë¬´ìƒíƒœí‘œ ë° ì†ìµê³„ì‚°ì„œ í…Œì´ë¸” í¬í•¨")
    print("  ğŸ“Š ë ˆë²¨ êµ¬ì¡° (ë“¤ì—¬ì“°ê¸°) ì ìš©")
    
    # 4. ê²€ì¦ í¬ì¸íŠ¸ ì•ˆë‚´
    print("\nğŸ¯ í…ŒìŠ¤íŠ¸ ê²€ì¦ í¬ì¸íŠ¸:")
    print("="*40)
    print("1. ğŸ“Š ë ˆë²¨ ê°ì§€ í…ŒìŠ¤íŠ¸:")
    print("   - Level 0: ìì‚°, ë¶€ì±„, ìë³¸ (ëŒ€ë¶„ë¥˜)")
    print("   - Level 1: ìœ ë™ìì‚°, ë¹„ìœ ë™ìì‚° ë“± (ì¤‘ë¶„ë¥˜)")
    print("   - Level 2: í˜„ê¸ˆë°í˜„ê¸ˆì„±ìì‚° ë“± (ì†Œë¶„ë¥˜)")
    
    print("\n2. â• í•©ê³„ ê²€ì¦ í…ŒìŠ¤íŠ¸:")
    print("   - ìœ ë™ìì‚° í•©ê³„: 50,000+30,000+40,000+25,000 = 145,000")
    print("   - ìˆ˜ìµ í•©ê³„: 400,000+5,000 = 405,000")
    print("   - ì˜¤ë¥˜í¬í•¨ì‹œíŠ¸: ìœ ë™ìì‚° í•©ê³„ 144,000 (ì˜¤ë¥˜)")
    
    print("\n3. ğŸ”„ êµì°¨ ì°¸ì¡° í…ŒìŠ¤íŠ¸:")
    print("   - ì¬ë¬´ìƒíƒœí‘œì™€ ì†ìµê³„ì‚°ì„œ ê°„ ê³µí†µ í•­ëª© í™•ì¸")
    print("   - ë‹¹ê¸°ìˆœì´ìµ ì¼ê´€ì„± ê²€ì¦")
    
    print("\n4. âš ï¸ ì˜¤ë¥˜ íƒì§€ í…ŒìŠ¤íŠ¸:")
    print("   - ì¤‘ë³µ í•­ëª© ê°ì§€")
    print("   - ë¹„ì •ìƒì  ìŒìˆ˜/ì–‘ìˆ˜ íŒ¨í„´")
    print("   - ë¹ˆ ì…€ ë¹„ìœ¨ ë¶„ì„")
    
    # 5. ì‹¤í–‰ ì•ˆë‚´
    print("\nğŸš€ DSD Breaker ê°ì‚¬ ë„êµ¬ ì‹¤í–‰:")
    print("="*40)
    print("python3 dsd_breaker_audit.py")
    print()
    print("ğŸ“ í…ŒìŠ¤íŠ¸ íŒŒì¼:")
    print("  â€¢ sample_financial_statements.xlsx")
    print("  â€¢ sample_audit_report.html")
    print()
    print("âœ… í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ!")

if __name__ == "__main__":
    main()